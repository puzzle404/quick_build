<%
  # Helper for status badge
  def status_badge(status)
    case status
    when 'completed'
      '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Completado</span>'.html_safe
    when 'processing'
      '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Procesando...</span>'.html_safe
    when 'queued'
      '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">En cola</span>'.html_safe
    when 'failed'
      '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Fallido</span>'.html_safe
    else
      "<span class=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800\">#{status}</span>".html_safe
    end
  end
%>

<div class="container mx-auto px-4 py-8">
  <div class="max-w-5xl mx-auto">
    <!-- Header -->
    <div class="mb-6 flex items-center justify-between">
      <div>
        <%= link_to "← Volver al plano", constructors_project_blueprint_path(@project.id, @blueprint.id), class: "text-indigo-600 hover:text-indigo-700 text-sm font-medium" %>
        <h1 class="mt-4 text-2xl font-bold text-slate-900">Historial de Análisis IA</h1>
        <p class="mt-1 text-sm text-slate-600">
          Todos los análisis realizados para este plano
        </p>
      </div>
      
      <%= link_to constructors_project_blueprint_ai_analyses_path(@project.id, @blueprint.id),
            method: :post,
            class: "px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium inline-flex items-center gap-2",
            data: { turbo: false, "turbo-method": :post } do %>

        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5">
          <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"/>
        </svg>

        Nuevo Análisis
      <% end %>

    </div>

    <!-- Analyses List -->
    <% if @analyses.any? %>
      <div class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden">
        <div class="divide-y divide-slate-200">
          <% @analyses.each do |analysis| %>
            <div class="p-4 hover:bg-slate-50 transition-colors">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <div class="flex items-center gap-3 mb-2">
                    <%= status_badge(analysis.status) %>
                    <span class="text-sm text-slate-500">
                      <%= time_ago_in_words(analysis.created_at) %> atrás
                    </span>
                    <% if analysis.applied? %>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                        ✓ Aplicado
                      </span>
                    <% end %>
                  </div>
                  
                  <% if analysis.completed? %>
                    <p class="text-sm text-slate-700">
                      Análisis completado exitosamente
                    </p>
                  <% elsif analysis.failed? %>
                    <p class="text-sm text-red-600">
                      <%= analysis.error_message&.truncate(150) || "Error desconocido" %>
                    </p>
                  <% elsif analysis.processing? %>
                    <p class="text-sm text-blue-600">
                      Analizando plano con IA...
                    </p>
                  <% else %>
                    <p class="text-sm text-slate-600">
                      En espera de procesamiento
                    </p>
                  <% end %>
                </div>
                
                <div class="flex items-center gap-2 ml-4">
                  <% if analysis.completed? %>
                    <%= link_to "Ver resultados", constructors_project_blueprint_ai_analysis_path(@project.id, @blueprint.id, analysis.id),
                                class: "px-3 py-1.5 text-sm font-medium text-indigo-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-lg transition-colors" %>
                  <% elsif analysis.processing? || analysis.status == 'queued' %>
                    <%= link_to "Ver estado", constructors_project_blueprint_ai_analysis_path(@project.id, @blueprint.id, analysis.id),
                                class: "px-3 py-1.5 text-sm font-medium text-blue-600 hover:text-blue-700 hover:bg-blue-50 rounded-lg transition-colors" %>
                  <% end %>
                  
                  <%= link_to constructors_project_blueprint_ai_analysis_path(@project.id, @blueprint.id, analysis.id),
                                method: :delete,
                                data: { confirm: "¿Eliminar este análisis?", "turbo-method": :delete },
                                class: "p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors" do %>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5">
                      <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd"/>
                    </svg>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% else %>
      <!-- Empty State -->
      <div class="text-center py-12 bg-white rounded-lg border border-slate-200">
        <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
        </svg>
        <h3 class="mt-4 text-lg font-medium text-slate-900">No hay análisis todavía</h3>
        <p class="mt-2 text-sm text-slate-600">
          Comenzá creando tu primer análisis con IA
        </p>
        <div class="mt-6">
          <%= link_to "Crear primer análisis", 
                      constructors_project_blueprint_ai_analyses_path(@project.id, @blueprint.id),
                      method: :post,
                      class: "inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium",
                      data: { turbo: false, "turbo-method": :post } %>
        </div>
      </div>
    <% end %>
  </div>
</div>
