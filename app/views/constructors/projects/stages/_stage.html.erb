<article id="<%= dom_id(stage) %>" class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm ring-1 ring-transparent transition hover:border-indigo-200 hover:ring-indigo-100">
  <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
    <div>
      <div class="flex flex-wrap items-center gap-2">
        <h4 class="text-lg font-semibold text-slate-900"><%= stage.name %></h4>
        <% if (period = project_stage_period(stage)).present? %>
          <span class="inline-flex items-center rounded-full bg-indigo-50 px-2.5 py-1 text-xs font-semibold text-indigo-600">
            <%= period %>
          </span>
        <% end %>
      </div>
      <p class="mt-2 text-sm text-slate-500"><%= stage.description.presence || "Sin descripción todavía." %></p>
    </div>

    <div class="flex shrink-0 flex-wrap items-center gap-2 text-xs text-slate-400">
      <% stage_lists = stage.material_lists %>
      <div class="flex items-center gap-1 rounded-full bg-slate-100 px-2.5 py-1 font-medium text-slate-600">
        <span>Listas:</span>
        <span><%= stage_lists.size %></span>
      </div>
      <% if policy(stage).destroy? %>
        <%= button_to "Eliminar",
                      constructors_project_stage_path(project, stage),
                      method: :delete,
                      data: { turbo_confirm: "¿Seguro que querés eliminar esta etapa? Las listas asociadas quedarán sin etapa." },
                      class: "inline-flex items-center rounded-full border border-red-200 px-3 py-1 font-semibold text-red-600 transition hover:bg-red-50" %>
      <% end %>
    </div>
  </div>

  <div class="mt-4 space-y-3">
    <% if stage_lists.any? %>
      <ul class="space-y-2">
        <% epoch = Time.zone.respond_to?(:at) ? Time.zone.at(0) : Time.at(0) %>
        <% stage_lists.sort_by { |list| list.updated_at || epoch }.reverse.each do |list| %>
          <li>
            <%= link_to constructors_project_material_list_path(project, list),
                        class: "group flex items-center justify-between gap-3 rounded-xl border border-slate-200 px-3 py-2 text-sm text-slate-600 transition hover:border-emerald-200 hover:bg-emerald-50 hover:text-emerald-700" do %>
              <span class="font-medium text-slate-800 group-hover:text-emerald-700"><%= list.name %></span>
              <span class="text-xs text-slate-400 group-hover:text-emerald-600">
                Actualizada hace <%= time_ago_in_words(list.updated_at) %>
              </span>
            <% end %>
          </li>
        <% end %>
      </ul>
    <% else %>
      <p class="rounded-xl border border-dashed border-slate-200 px-3 py-2 text-sm text-slate-500">
        Aún no vinculaste listas de materiales a esta etapa.
      </p>
    <% end %>

    <% if policy(project).manage_materials? %>
      <div>
        <%= link_to "Agregar lista de materiales",
                    new_constructors_project_material_list_path(project, project_stage_id: stage.id),
                    class: "inline-flex items-center rounded-lg bg-emerald-600 px-3 py-1.5 text-xs font-semibold uppercase tracking-wide text-white shadow-sm transition hover:bg-emerald-500" %>
      </div>
    <% end %>
  </div>
</article>
